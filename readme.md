

# MultiFlexMeter V3

Frequent, low-cost and flexible measurements using the MultiFlexMeter. An Open-Source sensor platform.
## Prerequisites

**Hardware**
 - KiCAD

**Firmware**
 - [PlatformIO](https://platformio.org)
 - Arduino-LMIC Submodule (`git submodule update --init`)
## Building and flashing

This project's firmware is designed for the ATMega1284p. It can be build using [PlatformIO](https://platformio.org/).

To build use:
```sh
pio run
```

To build and upload using AVRDude, use:
```sh
pio run -t upload
```

### Configuration

The MFM Firmware reads certain settings - including LoRaWAN keys - from the EEPROM. This requires the EEPROM to be programmed. 

The EEPROM has the data structure as shown below, where magic is "MFM\0". This data is positioned in the EEPROM at address 0x00:

```c
struct __attribute__((packed)) rom_conf_t {
  uint8_t MAGIC[4];
  struct {
    uint8_t MSB;
    uint8_t LSB;
  } HW_VERSION;
  uint8_t APP_EUI[8];
  uint8_t DEV_EUI[8];
  uint8_t APP_KEY[16];
  uint16_t MEASUREMENT_INTERVAL;
  uint8_t USE_TTN_FAIR_USE_POLICY;
};
```
## Troubleshooting

The main hardware is provided with an FTDI compatible header. If the firmware is built with debugging output on, extensive information about the running firmware will be printed to this UART output.
## Documentation

Due to the development of MFM V4, the documentation of V3 is sparse. Specific questions can be asked in the discussions page.

### Uplinks

|FPort|description|
|-|-|
|1|General purpose measurement result|
|2|System version, sent upon reset and includes HW version and FW version|

#### Measurement result

Measurement results exists of zero or more measurement packets, as shown below. Each packet is generated by a module. Therefore the packet begins with the module its address, then its type and lastly some blob of data that has a format specific to the module type.

`<Module Address> <Module Type> <Module Data Blob>`

### Downlinks

All downlinks can be sent on any port

|Bytes|description|
|-|-|
|`0x10 <BE uint16>`| Change sent interval in seconds |
|`0x11 <Addr> <Cmd> [Parameters]`|Send the command CMD to module with address ADDR  with optional parameters|
|`0xDE 0xAD`| Force a rejoin after 5 seconds |


## License

[MIT](https://choosealicense.com/licenses/mit/)

